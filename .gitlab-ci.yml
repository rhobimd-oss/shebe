#--------------------------------------------------------------------------------------
# Shebe CI/CD Pipeline
#
# Stages:
#   - prep: Placeholder job for MR pipelines
#   - test: Run tests, fmt check, clippy, coverage
#   - build: Build release binaries and upload to package registry (tags only)
#   - release: Create MCPB bundle and GitLab release (tags only)
#
# Build Strategy:
#   - build:linux: Native builds (rust-debian for glibc, rust-alpine for musl)
#   - package:mcpb: Creates MCP Bundle from musl binary
#   - Version extracted from Cargo.toml by rci tool
#
# Tools:
#   - rci v0.1.1-rc1: CI/CD automation tool (replaces bash scripts)
#     Downloaded from: registry.gitlab.com/rhobimd-oss/cicd (package registry)
#     New in 0.1.1: --publish-package-registry flag for build and mcpb create
#--------------------------------------------------------------------------------------

stages:
  - prep
  - test
  - build
  - release
  - publish

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  RUST_BACKTRACE: "1"
  SHEBE_SERVICE_DIR: services/shebe-server
  SHEBE_GITHUB_REPO: "rhobimd-oss/shebe"
  RCI_VERSION: "0.1.1"

# File changes to trigger rules
.shebe-changes: &shebe-changes
  paths:
    - services/shebe-server/Cargo.lock
    - services/shebe-server/Cargo.toml
  compare_to: refs/heads/main

# Rules for shebe service changes
.shebe-rules: &shebe-rules
  - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
    changes: *shebe-changes
  - if: $CI_MERGE_REQUEST_ID
    changes: *shebe-changes

# Rules for building
.build-rules: &build-rules
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
  - if: $CI_COMMIT_REF_NAME =~ /^v\d+\.\d+\.\d+/
  - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
    changes: *shebe-changes
  - if: $CI_MERGE_REQUEST_ID
    changes: *shebe-changes

# Rules for tag-based releases
.release-rules: &release-rules
  - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/

#--------------------------------------------------------------------------------------
# Test Stage
#--------------------------------------------------------------------------------------

dummy:job:
  stage: prep
  image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20251111-b3.13-alpine3.22-bc832d850
  interruptible: true
  timeout: 60s
  rules:
    - if: $CI_MERGE_REQUEST_ID
  variables:
    GIT_STRATEGY: none
  script:
    - time # anything that exits with status 0
  before_script: [] # Disable any global before_script
  after_script: [] # Disable any global after_script
  cache: {} # Disable caching
  artifacts:
    reports: {} # Disable artifact generation

.test:shebe:
  stage: test
  image: registry.gitlab.com/rhobimd-oss/cicd/lang/rust-alpine:20260119-b1.88-alpine3.22
  needs: [] # Don't wait for cache job (it's optional)
  interruptible: true
  timeout: 30m
  rules: *shebe-rules
  script:
    - |
      set -euo pipefail
      cd ${SHEBE_SERVICE_DIR}

      echo "=== Toolchain versions ==="
      rustc --version
      cargo --version
      cargo nextest --version
      cargo tarpaulin --version

      echo "=== Format check ==="
      cargo fmt -- --check --verbose

      echo "=== Build (compile dependencies) ==="
      cargo check --all-features --workspace

      echo "=== Clippy (shebe only) ==="
      cargo clippy --no-deps -- -D warnings

      echo "=== Tests ==="
      cargo nextest run --all-features --workspace

      echo "=== Coverage ==="
      cargo tarpaulin --skip-clean --all-features --workspace --out Xml --output-dir . --fail-under 60
  cache:
    - key: "shebe-deps"
      paths:
        - .cargo/registry/cache/
        - .cargo/registry/index/
        - .cargo/git/db/
      policy: pull-push
    - key: "shebe-target-linux-x86_64-musl"
      paths:
        - ${SHEBE_SERVICE_DIR}/target/
      policy: pull-push
  coverage: '/^\d+\.\d+% coverage/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: services/shebe-server/cobertura.xml
    expire_in: 1 week
    when: always

#--------------------------------------------------------------------------------------
# Build Stage
#
# Two parallel build paths:
# 1. Linux builds on GitLab CI (glibc + musl)
# 2. macOS builds on GitHub Actions (triggered via repository_dispatch)
#--------------------------------------------------------------------------------------

build:linux:
  stage: build
  parallel:
    matrix:
      - BUILD_IMAGE: lang/rust-debian:20260118-b1.88-slim-trixie
        ARTIFACT_SUFFIX: linux-x86_64
      - BUILD_IMAGE: lang/rust-alpine:20260119-b1.88-alpine3.22
        ARTIFACT_SUFFIX: linux-x86_64-musl
  interruptible: true
  timeout: 30m
  rules: *build-rules
  image: registry.gitlab.com/rhobimd-oss/cicd/${BUILD_IMAGE}
  variables:
    GIT_STRATEGY: fetch
    CARGO_TERM_COLOR: always
  before_script:
    - |
      curl -L --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
        "${CI_API_V4_URL}/projects/rhobimd-oss%2Fcicd/packages/generic/rci/${RCI_VERSION}/rci" \
        -o /usr/local/bin/rci
      chmod +x /usr/local/bin/rci
      rci --version
  script:
    - |
      rci build --service-dir services/shebe-server --suffix ${ARTIFACT_SUFFIX} --publish-package-registry
      if [ "${ARTIFACT_SUFFIX}" = "linux-x86_64-musl" ]; then
        rci mcpb create --service-dir services/shebe-server --publish-package-registry
      fi
  cache:
    - key: "shebe-deps"
      paths:
        - .cargo/registry/cache/
        - .cargo/registry/index/
        - .cargo/git/db/
      policy: pull-push
    - key: "shebe-target-${ARTIFACT_SUFFIX}"
      paths:
        - ${SHEBE_SERVICE_DIR}/target/
      policy: pull-push

#--------------------------------------------------------------------------------------
# Trigger GitHub Actions for macOS Builds
#
# Triggers GitHub Actions workflow to build macOS binaries (Intel and Apple Silicon).
# Runs in parallel with Linux builds for faster overall pipeline.
#
# CI/CD Variables Required:
#   SHEBE_GITHUB_TOKEN - GitHub Personal Access Token with repo scope (masked, protected)
#--------------------------------------------------------------------------------------

# Disabled for rci migration - macOS builds triggered separately
build:macos:
  stage: build
  image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20260119-b3.13-alpine3.22-b287ff20c
  interruptible: true
  timeout: 5m
  variables:
    GIT_STRATEGY: fetch
  needs:
    - job: build:linux
  rules: *build-rules
  script:
    - |
      set -euo pipefail

      # Get version from Cargo.toml
      VERSION="v$(grep '^version = ' services/shebe-server/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')"
      echo "Triggering GitHub Actions for macOS build (version: ${VERSION})..."

      # Trigger GitHub Actions workflow via repository_dispatch
      curl -sf -X POST \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${SHEBE_GITHUB_TOKEN}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        "https://api.github.com/repos/${SHEBE_GITHUB_REPO}/dispatches" \
        -d "{
          \"event_type\": \"build-macos\",
          \"client_payload\": {
            \"version\": \"${VERSION}\",
            \"ref\": \"${CI_COMMIT_REF_NAME}\",
            \"gitlab_pipeline\": \"${CI_PIPELINE_ID}\"
          }
        }"

      echo "Triggered GitHub Actions for macOS build"
      echo "Check progress at: https://github.com/${SHEBE_GITHUB_REPO}/actions"

#--------------------------------------------------------------------------------------
# Release Stage
#
# Creates releases on both GitLab and GitHub:
#   - GitLab: Primary release with asset links to package registry
#   - GitHub: Draft release with uploaded artifacts (for Zed extension compatibility)
#
# CI/CD Variables Required:
#   SHEBE_GITHUB_TOKEN - GitHub PAT with repo scope (masked, protected)
#
# Note: Artifacts already uploaded to package registry by build jobs.
#--------------------------------------------------------------------------------------

release:shebe:
  stage: release
  image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20260119-b3.13-alpine3.22-b287ff20c
  interruptible: true
  needs:
    - job: build:linux
  rules: *build-rules
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: 0
  before_script:
    - git config --global --add safe.directory "${CI_PROJECT_DIR}"
    - |
      curl -L --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
        "${CI_API_V4_URL}/projects/rhobimd-oss%2Fcicd/packages/generic/rci/${RCI_VERSION}/rci" \
        -o /usr/local/bin/rci
      chmod +x /usr/local/bin/rci
      rci --version
  script:
    - rci release gitlab --service-dir services/shebe-server
    - rci release github --service-dir services/shebe-server

#--------------------------------------------------------------------------------------
# Publish to MCP Registry (Manual Trigger)
#
# Publishes Shebe to the official MCP Registry (registry.modelcontextprotocol.io).
# Runs after release:shebe to ensure download URLs in server.json are valid.
#
# CI/CD Variables Required:
#   MCP_PRIVATE_KEY - Private key for DNS-based authentication (masked, protected)
#
# Manual trigger to prevent accidental publication to public registry.
#--------------------------------------------------------------------------------------

publish:mcp-registry:
  stage: publish
  image: registry.gitlab.com/rhobimd-oss/cicd/alpine:20260119-b3.13-alpine3.22-b287ff20c
  needs:
    - job: build:linux
    - job: release:shebe
  rules: *build-rules
  variables:
    GIT_STRATEGY: fetch
  before_script:
    - |
      curl -L --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
        "${CI_API_V4_URL}/projects/rhobimd-oss%2Fcicd/packages/generic/rci/${RCI_VERSION}/rci" \
        -o /usr/local/bin/rci
      chmod +x /usr/local/bin/rci
      rci --version
  script:
    - rci mcpb publish --verify
